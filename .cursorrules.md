# Cursor Rules for Event Ticketing App
- Always read SPEC.md before making changes

## Tech Stack & Architecture
- **Next.js App Router only** - No Pages Router. Use Server Components by default.
- **TypeScript** - Strict mode enabled. Type everything.
- **Supabase** - PostgreSQL database with Row Level Security (RLS) enabled on all tables.
- **Tailwind CSS + shadcn/ui** - Use shadcn/ui components for all UI. Run `npx shadcn@latest add [component]` when needed (CLI package is `shadcn`, not deprecated `shadcn-ui`).

## Code Patterns

### Server Components First
- Default to Server Components. Only use Client Components (`'use client'`) when necessary (interactivity, hooks, browser APIs).
- Use Server Actions for all database mutations and form submissions.
- Use Route Handlers (`route.ts`) for webhooks and external API integrations.

### Supabase SSR
- Use `@supabase/ssr` for cookie-based authentication in App Router.
- Create Supabase client using `createServerClient` from `@supabase/ssr` in Server Components.
- Use `createBrowserClient` in Client Components.

### Authentication & Security
- **MFA is mandatory** for all admin/helper accounts.
- Middleware must check `supabase.auth.mfa.getAuthenticatorAssuranceLevel()` returns `aal2` for all `/admin` routes.
- Redirect to MFA challenge if assurance level is insufficient.
- All admin routes protected by Supabase session middleware.
- Validate `Stripe-Signature` header on all webhook requests using `stripe.webhooks.constructEvent()`.

### Validation
- **Zod** for all server-side input validation.
- Validate all user inputs, file uploads, and API payloads.
- Never trust client-side data.

### Error Handling
- All Server Actions return `{ success: boolean, data?: T, error?: string }` shape.
- Never throw errors to the client. Always return error objects.
- Provide clear, user-friendly error messages.

## Database Conventions

### Dates & Timezones
- Store all dates in UTC (`timestamptz`).
- Display dates in local time using `date-fns-tz`.
- Use `date-fns` for date manipulation.

### Identifiers
- **Slugs**: Generate as `kebab-case-title` + `-` + 6 random alphanumeric characters (e.g., `harvest-dinner-x7k2m9`).
- **Ticket codes**: Store as UUID. Display as plain text in Phase 1. Leave `// TODO Phase 2: render QR image here` placeholder.

### Row Level Security
- RLS must be enabled on all tables.
- Enforce role-based access: Admin has full access, Helper cannot access `/admin/team` or `/admin/settings`.

## File Uploads & Storage

- **Supabase Storage**: Use `event-assets` bucket.
  - Images: public access.
  - CSVs: private, access via signed URLs only.
- **CSV parsing**: Use Papa Parse server-side. Stream files > 1MB.
- **Validation**: `.csv` files only, max 5MB.
- **Multiple uploads**: Process each CSV independently. Deduplicate contacts after each import.

## Stripe Integration

- Use **Stripe Checkout** (hosted) for PCI compliance.
- Auto-create Stripe Product + Price when creating paid ticket tiers.
- Store `stripe_price_id` in `ticket_tiers` table.
- Validate `max_per_contact` server-side before creating Checkout Session:
  ```sql
  SELECT SUM(quantity) FROM tickets 
  WHERE event_id = X AND tier_id = Y 
  AND (attendee_email = Z OR attendee_phone = W) 
  AND status != 'cancelled'
  ```
- Reject with clear error if limit exceeded.
- Webhook handlers:
  - `checkout.session.completed`: Create confirmed tickets, send confirmation email.
  - `charge.refunded`: Update ticket status to `refunded`.

## Email & SMS

- **Resend** for email with React Email templates.
- **Twilio** for SMS via Messaging Service.
- All messages logged in `invitation_logs` table.
- Respect `invitation_channel` enum per contact (`email`, `sms`, `both`, `none`).

## UI Components

- Use **shadcn/ui** components exclusively (CLI: `npx shadcn@latest add [component]`).
- Follow shadcn/ui patterns and styling conventions.
- Keep components focused and reusable.
- Colocate component styles with components.

## Phase 1 vs Phase 2

- **Phase 1**: Printable ticket card as PNG using html2canvas.
- **Phase 2**: QR codes and Apple Wallet `.pkpass` generation.
- Leave clear TODO comments for Phase 2 features.
- Keep Phase 1 code clean and extensible for Phase 2 additions.

## Event Lifecycle

- **Draft** → **Published** (`is_published = true`, `link_active = true`) → **Archived** (`status = archived`, `link_active = false`).
- Only manual archive action sets `link_active = false`. Never auto-archive.
- Post-event page only renders if `date_end < now()`.
- Archived events return 404 on public landing page but remain visible in `/admin/archive`.

## Code Quality

- Keep functions focused and single-purpose.
- Extract reusable logic into custom hooks or utilities.
- Use TypeScript types from database schema (consider generating types from Supabase).
- Follow Next.js best practices for App Router.
- Write self-documenting code with clear variable names.

## Testing Considerations

- All database operations should be testable.
- Server Actions should be pure where possible.
- Mock external services (Stripe, Twilio, Resend) in tests.
- All inputs validated with Zod on the server.

## Documentation

- Update `SPEC.md` when adding, changing, or removing features.
- Include JSDoc comments for complex functions.
- Document API routes and Server Actions.
